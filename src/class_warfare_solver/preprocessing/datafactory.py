from class_warfare_solver.utils.methods import initialize_spark
import pandas as pd
from pyspark.sql import SparkSession, functions as F

class DataFactory():

    def __init__(self, databricks=False):
        # spark doesn't like data not on dbfs, will move to volumes later
        # Plus that way columns will be correct type instead of all str
        self.prefix = "../../../" if not databricks else ""
        self._is_data_cleaned = False

    def search_for_copper(self):

        self._clean_class_growths()
        self._clean_class_bases()
        self._clean_character_bases()
        self._clean_character_growths()
        self._is_data_cleaned = True

        return None

    def find_gold(self):

        if not self._is_data_cleaned:
            raise ValueError(raw_errror)


        return None
    
    def load_raw_tables(self):

        self._class_bases = spark.createDataFrame(pd.read_csv(f"{self.prefix}data/Class Bases.csv"))
        self._class_growths = spark.createDataFrame(pd.read_csv(f"{self.prefix}data/Class Growths.csv"))
        self._character_bases = spark.createDataFrame(pd.read_csv(f"{self.prefix}data/Character Bases.csv"))
        self._character_growths = spark.createDataFrame(pd.read_csv(f"{self.prefix}data/Character Growths.csv"))

        return None


    def _clean_class_bases(self):
        class_bases = self._class_bases
        
        class_bases = (
            class_bases
            .withColumn("Class", F.trim(F.get(F.split(class_bases.Class, '[(*)]', 2), 0)))
            .withColumn("Class", F.split(class_bases.Class, '[/,]', 2))
            .withColumn("Class", F.explode(class_bases.Class))
            .withColumn("Class", F.trim(F.col('Class')))
            .where(F.col("Class").isNotNull() & (F.col("Class") != ""))
            .where(F.col("Game") != "Game")
            .dropDuplicates(["Game", "Class"])
            .fillna("0", subset=["Lck"])
            .withColumn("Mag", F.when(F.col("Mag").isNull(), F.col("Str")).otherwise(F.col("Mag")))
            .withColumn("Res", F.when(F.col("Res").isNull(), F.col("Def")).otherwise(F.col("Res")))
            .withColumn("Mov", F.trim(F.get(F.split(class_bases.Mov, '[»]', 2), 0)))
        )

        for col in ["HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res"]:
            class_bases = class_bases.withColumn(col, F.cast(int, F.col(col)))
        
        self._class_bases = class_bases.select([
            "Game", "Class", "HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res", "Mov"
        ])
        return None
    
    def _clean_class_growths(self):
        class_growths = self._class_growths

        class_growths = (class_growths
            .withColumn("Class", F.trim(F.get(F.split(class_growths.Class, '[(*)]', 2), 0)))
            .withColumn("Class", F.split(class_growths.Class, '[/,]', 4))
            .withColumn("Class", F.explode(class_growths.Class))
            .withColumn("Class", F.trim(F.col('Class')))
            .where(F.col("Class").isNotNull() & (F.col("Class") != ""))
            .where(F.col("Game") != "Game")
            .dropDuplicates(["Game", "Class"])
            .withColumn("Mag", F.when(F.col("Mag").isNull() & F.col("Game").isin([2, 6, 7, 8]), F.col("Str")).otherwise(F.col("Mag")))
            .withColumn("Res", F.when(F.col("Res").isNull() & F.col("Game").isin([5]), F.col("Def")).otherwise(F.col("Res")))
            .fillna("0")
        )

        for col in ["HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res"]:
            class_growths = class_growths.withColumn(col, F.cast(int, F.col(col)))

        self._class_growths = class_growths.select([
            "Game", "Class", "HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res"
        ])
        return None

    def _clean_character_bases(self):
        character_bases = self._character_bases

        character_bases = (
            character_bases
            .withColumn("Name", F.trim(F.get(F.split(character_bases.Name, '[ *]', 2), 0)))
            .where(F.col("Class").isNotNull() | (F.col("Game") == 13))
            .dropDuplicates(["Game", "Name"])
            .withColumn("Class", F.trim(F.get(F.split(character_bases.Class, '[ *]', 2), 0)))
            .where(F.col("Game") != "Game")
            .withColumn("Mag", F.when(F.col("Mag").isNull() & F.col("Game").isin([2, 6, 7, 8]), F.col("Str")).otherwise(F.col("Mag")))
            .withColumn("Res", F.when(F.col("Res").isNull() & F.col("Game").isin([5]), F.col("Def")).otherwise(F.col("Res")))
            .fillna("0", subset=["Mov"])
        )
        for col in ["HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res", "Mov"]:
            character_bases = character_bases.withColumn(col, F.cast(int, F.get(F.split(F.col(col), '[+]', 2), 0)))

        self._character_bases = character_bases.select([
            "Game", "Name", "Class", "HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res", "Mov"
        ])
        return None
    
    def _clean_character_growths(self):
        character_growths = self._character_growths

        character_growths = (
            character_growths
            .withColumn("Name", F.trim(F.get(F.split(character_growths.Name, '[(*]', 2), 0)))
            .dropDuplicates(["Game", "Name"])
            .where(F.col("Game") != "Game")
            .withColumn("Mag", F.when(F.col("Mag").isNull() & F.col("Game").isin([2, 6, 7, 8]), F.col("Str")).otherwise(F.col("Mag")))
            .withColumn("Res", F.when(F.col("Res").isNull() & F.col("Game").isin([5]), F.col("Def")).otherwise(F.col("Res")))
        )
        for col in ["HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res"]:
            character_growths = character_growths.withColumn(col, F.cast(int, F.when(F.col(col) == "–", 0).otherwise(F.col(col))))

        self._character_growths = character_growths.select([
            "Game", "Name",  "HP", "Str", "Mag", "Skl", "Spd", "Lck", "Def", "Res",
        ])
        return None


raw_errror = """
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@%#####%%@%%%%%%%%%%%%%%%%%%%%%%@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@%#####%%@%%%%%%%%%%%%%%%%%%%%%%@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%%%%%@%%%%%%%%%%%%%%%@@@%####%@@@%%###%%@@@%%%%%%%%%%%%%%%%%%%%%@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#:...-+-.........+...=@+.......:*@%%###%%@@@%%%%%%%%%%%%%%%%%%%%%@@
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#:...-*=:......::*...=*...:=-...-%%%###%%%@@@%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@#:.. -%@@*:...=@@@+.:*+...:**...-#%%###%%%@%@%%%%%%%%%%%%%%%%%%%%%@
%%%@@@@@@%%%%%%%%@@%%%@@@@@%%@@%@%:.. -%%@#:...=@@@@@@@#.....-#@@@@%%####%@@%@%%%%%%%%%%%%%%%%%%%%%%
%#**######%%%%%###%%#*#%%%%@%%%%@#:.. -%#%*:...=@%*#@@@@#:......+@@%#####%@@%@%%%%%%%%%%%%%%%%%%%%%@
+++++++****##*++++++++++*##%%%##%#:...-#*#*:...=@+***#@@@@%+.....:#@%####%%@@%%%%%%%%%%%%%%%%%%%%%%%
+======++++**++========++*######%#:...-#*#*:...=@+===+%#:::-**....*@%####%%@@%%%%%%%%%%%%%%%%%%%%%%@
==-===+=+++++++=========+**###**##:...-#*#*:...=@+=-=-##...:*#-...+%%####%%%%%%%%%%%%%%%%%%%%%%%%%%@
=====+++++++++++++++===++++++++=*#:...-##%*:...=@***++#%-...::....*@%####%%@@%%%%%%%%%%%%%%%%%%%%%%%
=====+++++++++++++++==+===+=+=++*%-:::=%*##-:::=@**+++*@%*-....:+#@%####%%%@@%%%%%%%%%%%%%%%%%%%%%%%
====++++++++++++*+++=======+====+#######+*##%%%#%###**+**#%@@@@@%%***#%%%%%%@%%%%%%%%%%%%%%%%%%%%%%%
*+++++++********++++++++*++++++=+++++++**###**###*#***++++++****###**%%%%@@@%%%%%%%%%%%%%%%%%%%%%%%#
***********####**+++++***#*++++=+*##***########***+++++++++++****#%#**%@@@@@@%%%%%%%%%%%%%%%%%%%%%##
#####*******####******####+=+*+++##*++*****+**++++=====+++++++****###**%%%@@%@%%%%%%%%%%%%%%%%%%##**
*******+++****#*****#####*=+***+*#*++++==================+++++*****##***#%@@%@%%%%%%%%%%%%%%%%%%###*
*************##########%#++*###*+*++++============-=========+++*##*#****#%%@@@%%%%%%%%%%%%%%%%%%%###
######*****###########%%%#**#%%#*++++=======----==============+*#####***#%%@@%%%%%##***#%%%%%%%%%%%%
%%%%%%%%#%%%%%%%%%%%%%%%%%%######*++============----=========++++*###***%%@@%##*++=====+*#%%%%%%%%%%
@@@%%%%%%%%%%%%%%%%%%%%%%%%%#####+++==============-=======++++**#*+######%%%#*+==----===+*%%@@@@@@%%
@@@@%%%%%%%%%%%%%%%%%%%%%%%%*###*++++=====------=============+++*####*+*%%%%#*+=-----==++*#%@@@@@@@@
@@@%%%%%%%%%%%%%%%%%%%%%%%%#*###**+==+======-=======+**++++====++*#*++*=#%@@%#++===++*****#%@@@@@@@@
@@@@@%%%%%%%%%%%%%%%%%%%%%%%###*#*++=====+++=====++*####**+++====+**+=++#%@@@%##*******#%%%%@@@@@@@@
@@@@@@@%%%%%%%%%%%%%%%%%%%%%%#####+=+++**####*=--=++***#*+++=====++*+==+*%@@@@@%%###**#%%%%%%%%@%%%%
@@@@@@@@%%%%%%%%%%%@@@%%%%%%%%#*##*+++*#%#***+========++==========++++==*%@@@@%%##*##%%%@@%%%%%%%%%%
@@@@@@@@%%%%%%%%%@@@@@@@@@%%%%#***+++**+++++==============---======++===*%%@%%%####%%%%@@%%%%%%%%%%%
@@@@@@@@%%%%%%%%@@@@@@@@@@@%%%%#**+=================+++=---=======++=-==#%%@%%%%%%%%%@@%%%%%%%%%%%%%
@@@@@@@@@@@@%%%%@@@%@@@%@@@@%%%%**++=======++==--=====+++=========++==-:::--====+#%%%%%%%%%%%%%%%%%%
@@@@@@@@@@@@@@@@@%%%#####%%@@@@%#++++=====++++++++++++==+*+=======+++=-:::::::::....::--===*####%%%%
@@@@@@@@@@@@@@@%%%##*****##%%%@@%++++++=++********+++===+++++=====+++=-::::.....::::::::::-=**++*%%%
%%%%%%%%%%%%%%%%##**++++***##%%%%*++++++++**+++++=+===++++++++====++==-:::.......:..:::::::-+*+++#%%
%%%%%%%%%%%%%###***++++++****###%%#**+++++**+++******##%%%*+++==++++==::..........::.::::::-=++===*%
%%%%%%%%%%%###****++++++++++****##%%%#+++++**%@%%%##%##***+++++==+++==-:............::.::::::-=+===+
%%%%%%%%%%###*****+**+++**++*****##%%%*+++=++*#******+++*+=++==++++=++-:.............:::..:::::-===+
%%%%%%%%%###**********************###=:-++==++++++++++========+++++++=:..............::::......::---
%%%%%%%%%##**********#######******=.::::-+++==++====++=++=====+++++++=:...............:::::.........
@%%%%%%%###*********####%%%###*+:..::::::-++===++++++========+++*+++=:.................:::::.:::::..
@%%%%%%%###********#####%%%%%+...:::::--:::=+==++=+========+++*+++++::..................:::::..:::::
%%%%##%%##******###**#####%=...:::::::--::::-+++=++==++++++***+++++=:::.................::::::...:::
#####%%%%################=...:::::::::---::::-+*+++++++*******+++++=:...................:::::::..:::
*####%%%%%#############=:..:::::::::::---:::::-=+**#******+***++++=-::....................::::::...:
+*##%%%%%%%%%%####%##+:..:::::::---:::----:::::--=*#*********+++=-::...:...................::::::...
*###%%%%%%%%%%%%%%%#-......::::::--:::----:::::::--+##*******+=-::....:.....................::::::..
*####%%%%%%%%%%%%%*:......:::::::---:::----::::::---======-----:.....................::.......::::::
*#####%%%%%%%%%%%%=......::::::::--:--:----:::.::::------::::::......................:::.......:::-:
*######%%@%%%%%%##=:...::::::::::::::-::---::::.:::::-----:...........................::::.......:::
*####%%%%@@%%%%##*-::..::::::::::::::--:---:::::..::::::::::.......:...................::::.......::
*####%%%%@@%%%%##*-::::.:::::::::::::--::--:::::-::::::::..........::::................:::::........
######%%%%@@%%%##*-:::::::::::::::::---::---:-::::---:::............::::::.............:::::::......
#######%%%@@%%%##*-::-:::.::::::::::---::------:::::--::.............:::::::::.........::::::::::::.
##@%%%%%%@@%%@@%%%%+#%@%%@%*#####%#############%%####+%%%%@%#=..:*#######*-+######%%##############%=
##%.....:=:..+=...#@=......+%+..:*+..=+:..+*:..*@...%%-.....-%*.-*-......=@@*....:##...*#:..=%-..:@-
##%...-*#*:..++...#+...#+...#=..:=..:#*:..+*:...@...%+..:+:..=*:-*-..-*:..*@-.....=%-..+*...-#-..=@:
##%...=@@*...++...#=...#+...*=...:..+@*:..+*:...+...%=..:+:..=+:-*-..-*:..*@...-..-%=..++...:+:..+#:
*#%.....-*:..++...#=...%@%%%%=.....:*@*:..+*:.......%=..:+---+#==*-......*@#..:#..:#+..--....=:..#*-
==%...-#%*...++...#=...%*---#=......=@*:..+*:.:... .%=..:+:..=*==*-..-*:..#+..:%..:**.....-:.:...%=-
=+%...=%+#:..+=...#+...%+...#=..:=..:**:..+*:.:+....%=..:*=..=*-=*-..-#:..*-.......=#:....*=....-@=-
++%...=%+%=..::..-%#:..-:..-@=..:+-..=+:..+*:.:%:...%#...:...=*--*-..-#:..*...-%-..-#-...-#+....+#--
++@+++#%-*%#+===*%#%%*===+#@@#++*%#++***++#%*+*@#+++@@%+==**+#*:-**++*%*++#+++#@#++*%#+++*@%*+++#*--
*+++++++==++****=-:-=======--==--==+++====-------:---:-==----::..:::-------------------:::--------:-
********###*###*=::::----:::--------====---:::--::::::..::::::::::....::::::::::::::::::..:::--:::::
"""

if __name__ == "__main__":
    spark = initialize_spark()

    df = DataFactory()

    df.load_raw_tables()
    df.search_for_copper()
    df.find_gold()